;
; Pruebas_Proyecto_3_micros.asm
;
; Created: 2/27/2025 2:12:51 PM
; Author : oscar
;
.include "M328PDEF.inc"
.cseg
.org 0x0000
	JMP START
.org 0x0008
	JMP PINCHANGEC_ISR
.org 0x0020
	JMP TMR0_ISR


START:
// Configuraci n de la pila?
	LDI R16, LOW(RAMEND)
	OUT SPL, R16
	LDI R16, HIGH(RAMEND)
	OUT SPH, R16	

DIS: .DB 0x3F,0x05,0x5B,0x4F,0x65,0x6E,0x7E,0x07,0x7F,0x67,0x77,0x7F,0x3A,0x3F,0x7A,0x72
MESES: .DB 0x20,0x1D,0x20,0x1F,0x20,0x1F,0x20,0x20,0x31F,0x20,0x1F,0x20

SETUP:
	CLI



	LDI R16,(1 << CS01)|(1 << CS00)
	OUT TCCR0B, R16
	LDI R16,100
	OUT TCNT0, R16

	LDI R16, (1 << TOIE0)
	STS TIMSK0, R16

	LDI R16, (1 << PCIE1)
	STS PCICR, R16
	LDI R16,(1 << PCINT13)|(1 << PCINT11)|(1 << PCINT10)|(1 << PCINT9)|(1 << PCINT8)
	STS PCMSK1, R16

	
	LDI R16,0x00
	OUT PORTD, R16
	OUT PORTB, R16
	STS UCSR0B, R16
	LDI R16,0x30
	OUT DDRC,R16
	LDI R16,0xFF
	OUT PORTC, R16
	OUT DDRB,R16
	OUT DDRD, R16
	
	SEI

	LDI R16,0x00
	MOV R0,R16
	MOV R1,R16
	MOV R2,R16
	MOV R3,R16
	MOV R4,R16
	MOV R5,R16
	MOV R6,R16
	MOV R7,R16
	MOV R8,R16 
	MOV R9,R16
	MOV R10,R16
	MOV R11,R16
	MOV R12,R16
	MOV R13,R16 
	MOV R14,R16 

// Contador horas y mins
	LDI R16,0x00
	LDI R17,0x00
	LDI R18,0x00
	LDI R19,0x00
// Contadores para minutos
	LDI R20,0x00
	LDI R21,0x00
// Valor a mostrar en displays
	LDI R22,0x00
// Valores temporales
	LDI R23,0x00
// Modo del sistema
	LDI R24,0x00
// Registros Alarma y Fecha
	LDI R25,0x00
	LDI R26,0x00
	LDI R27,0x00
	LDI R28,0x00
// Registro para puntos cada 500ms
	LDI R29,0x00
//ANTIREBOTE
// Registro para el delay de los displays
	LDI R31,0x00

MAIN_LOOP:
	MOV R0,R16
	MOV R1,R17
	MOV R2,R18
	MOV R3,R19
	ANDI R24,0x07 
	CPI R24,0x00
	BREQ SALTO_APAGADO
	CPI R24,0x01
	BREQ SALTO_RELOJ
	CPI R24,0x02
	BREQ SALTO_FECHA
	CPI R24,0x03
	BREQ SALTO_CONFIG_HORA
	CPI R24,0x04
	BREQ SALTO_CONFIG_FECHA
	CPI R24,0x05
	BREQ SALTO_CONFIG_ALARMA
	CPI R24,0x06
	BREQ SALTO_APAGAR_ALARMA
	JMP MAIN_LOOP

RESTRICCIONES:
	CPI R21, 24
	BRNE FINAL
	CLR R20
	CLR R21
	INC R16	
	CPI R16,0x0A
	BREQ OVER_UNIDADES_SEGUNDOS
CASO2_RELOJ:
	CPI R17,0x06
	BREQ OVER_DECENA_SEGUNDOS
CASO3_RELOJ:
	CPI R18,0x04
	BREQ OVER_UNIDADES_HORA
CASO4_RELOJ:
	CPI R18,0x0A
	BREQ OVER_DECENAS_HORA
CASO5_FECHA:

FINAL:
RET

OVER_UNIDADES_SEGUNDOS:
	LDI R16, 0x00
	INC R17
	RJMP CASO2_RELOJ
OVER_DECENA_SEGUNDOS:
	LDI R17, 0x00
	INC R18
	RJMP CASO3_RELOJ
OVER_UNIDADES_HORA:
	CPI R19,0x02
	BRNE CASO4_RELOJ
	LDI R18,0x00
	LDI R19,0x00
	INC R4
	RJMP CASO5_FECHA
OVER_DECENAS_HORA:
	LDI R18,0x00
	INC R19
	RJMP CASO5_FECHA

SALTO_APAGADO:
	JMP APAGADO
SALTO_RELOJ:
	JMP RELOJ
SALTO_FECHA:
	JMP FECHA
SALTO_CONFIG_HORA:
	JMP CONFIG_HORA
SALTO_CONFIG_FECHA:
	JMP CONFIG_FECHA
SALTO_CONFIG_ALARMA:
	JMP CONFIG_ALARMA
SALTO_APAGAR_ALARMA:
	JMP APAGAR_ALARMA

APAGADO:
	CBI PORTB,0
	CBI PORTB,1
	CBI PORTB,2
	CBI PORTB,3
	CBI PORTB,4
	CBI PORTB,5
	CBI PORTC,4
	LDI R22, 100
	OUT TCNT0, R22
	JMP MAIN_LOOP

RELOJ:
	CALL RESTRICCIONES
	SBI PORTB,4
	CBI PORTB,5
	CPI R29, 50
	BRNE RELOJ_MOSTRAR
	CLR R29
	SBIS PINC,4
	JMP ENCENDER
	SBIC PINC,4
	RJMP APAGAR
ENCENDER:
	SBI PORTC,4
	RJMP COMPARAR_ALARMA
APAGAR:
	CBI PORTC,4
COMPARAR_ALARMA:
	MOV R23,R8
	CP R16, R23
	BREQ COMPARAR2
	CBI PORTC,5
	JMP RELOJ
COMPARAR2:
	MOV R23,R9
	CP R17, R23
	BREQ COMPARAR3
	CBI PORTC,5
	JMP RELOJ
COMPARAR3:
	MOV R23,R10
	CP R18, R23
	BREQ COMPARAR4
	CBI PORTC,5
	JMP RELOJ
COMPARAR4:
	MOV R23,R11
	CP R19, R23
	BREQ COMPARAR5
	CBI PORTC,5
	JMP RELOJ_MOSTRAR
COMPARAR5:
	LDI R23,0x01
	CP R12,R23
	BREQ ACTIVAR_ALARMA
	CBI PORTC,5
	JMP RELOJ_MOSTRAR
ACTIVAR_ALARMA:
	SBI PORTC, 5
RELOJ_MOSTRAR:
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R16
	LPM R23, Z
	CBI PORTB, 0
	CBI PORTB, 1
	CBI PORTB, 2
	CBI PORTB, 3
	OUT PORTD, R23
	SBI PORTB, 0
	CALL DELAY
	CBI PORTB, 0
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R17
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 1
	CALL DELAY
	CBI PORTB, 1
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R18
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 2
	CALL DELAY
	CBI PORTB, 2
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R19
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 3
	CALL DELAY
	CBI PORTB, 3
	JMP MAIN_LOOP


FECHA:
	CALL RESTRICCIONES
	SBI PORTB, 0
	SBI PORTB, 1
	SBI PORTB, 2
	SBI PORTB, 3
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R25
	LPM R23, Z
	CBI PORTB, 0
	CBI PORTB, 1
	CBI PORTB, 2
	CBI PORTB, 3
	OUT PORTD, R23
	SBI PORTB, 0
	CALL DELAY
	CBI PORTB, 0
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R26
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 1
	CALL DELAY
	CBI PORTB, 1
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R27
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 2
	CALL DELAY
	CBI PORTB, 2
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R28
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 3
	CALL DELAY
	CBI PORTB,3
	JMP MAIN_LOOP
	JMP MAIN_LOOP

CONFIG_HORA_CASO1:
	LDI R25,0x00
	INC R26
	JMP CONFIG_HORA_MINS_UNIDADES2
CONFIG_HORA_CASO2:
	LDI R25,0x09
	DEC R26 
	JMP CONFIG_HORA_MINS_DECENAS
CONFIG_HORA_CASO3:
	LDI R26,0x00
	JMP CONFIG_HORA_MINS_DECENAS2
CONFIG_HORA_CASO4:
	LDI R26,0x5
	JMP CONFIG_HORA_HORAS_UNIDADES
CONFIG_HORA_CASO5:
	LDI R27,0x00
	INC R28
	JMP CONFIG_HORA_HORAS_UNIDADES2
CONFIG_HORA_CASO6:
	CPI R28,0x00
	BREQ CONFIG_HORA_REINICIO
	LDI R27,0x09
	DEC R28
	JMP CONFIG_HORA_HORAS_DECENAS
CONFIG_HORA_CASO7:
	CPI R27,0x04
	BRNE CONFIG_HORA_MOSTRAR
	LDI R27,0x00
	LDI R28,0x00
	JMP CONFIG_HORA_MOSTRAR
CONFIG_HORA_REINICIO:
	LDI R27,0x03
	LDI R28,0x02
	JMP CONFIG_HORA_MOSTRAR

CONFIG_HORA:
	CBI PORTB,0
	CBI PORTB,1
	CBI PORTB,2
	CBI PORTB,3
	CBI PORTB,4
	CBI PORTB,5
	CBI PORTC,4
	LDI R22, 100
	OUT TCNT0, R22
	CPI R25,0x0A
	BREQ CONFIG_HORA_CASO1
CONFIG_HORA_MINS_UNIDADES2:
	CPI R25,0xFF
	BREQ CONFIG_HORA_Caso2
CONFIG_HORA_MINS_DECENAS:
	CPI R26,0x06
	BREQ CONFIG_HORA_CASO3
CONFIG_HORA_MINS_DECENAS2:
	CPI R26,0xFF
	BREQ CONFIG_HORA_CASO4
CONFIG_HORA_HORAS_UNIDADES:
	CPI R27,0x0A
	BREQ CONFIG_HORA_CASO5
CONFIG_HORA_HORAS_UNIDADES2:
	CPI R27,0xFF
	BREQ CONFIG_HORA_CASO6
CONFIG_HORA_HORAS_DECENAS:
	CPI R28,0x02
	BREQ CONFIG_HORA_CASO7
CONFIG_HORA_MOSTRAR:
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R25
	LPM R23, Z
	CBI PORTB, 0
	CBI PORTB, 1
	CBI PORTB, 2
	CBI PORTB, 3
	OUT PORTD, R23
	SBI PORTB, 0
	CALL DELAY
	CBI PORTB, 0
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R26
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 1
	CALL DELAY
	CBI PORTB, 1
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R27
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 2
	CALL DELAY
	CBI PORTB, 2
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R28
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 3
	CALL DELAY
	CBI PORTB, 3
	JMP MAIN_LOOP

CONFIG_FECHA:
	LDI R22, 100
	OUT TCNT0, R22
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R25
	LPM R23, Z
	CBI PORTB, 0
	CBI PORTB, 1
	CBI PORTB, 2
	CBI PORTB, 3
	OUT PORTD, R23
	SBI PORTB, 0
	CALL DELAY
	CBI PORTB, 0
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R26
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 1
	CALL DELAY
	CBI PORTB, 1
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R27
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 2
	CALL DELAY
	CBI PORTB, 2
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R28
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 3
	CALL DELAY
	CBI PORTB,3
	JMP MAIN_LOOP

CONFIG_ALARMA_CASO1:
	LDI R25,0x00
	INC R26
	JMP CONFIG_ALARMA_MINS_UNIDADES2
CONFIG_ALARMA_CASO2:
	LDI R25,0x09
	DEC R26 
	JMP CONFIG_ALARMA_MINS_DECENAS
CONFIG_ALARMA_CASO3:
	LDI R26,0x00
	JMP CONFIG_ALARMA_MINS_DECENAS2
CONFIG_ALARMA_CASO4:
	LDI R26,0x5
	JMP CONFIG_ALARMA_HORAS_UNIDADES
CONFIG_ALARMA_CASO5:
	LDI R27,0x00
	INC R28
	JMP CONFIG_ALARMA_HORAS_UNIDADES2
CONFIG_ALARMA_CASO6:
	CPI R28,0x00
	BREQ REINICIO_CONFIG_ALARMA
	LDI R27,0x09
	DEC R28
	JMP CONFIG_ALARMA_HORAS_DECENAS
CONFIG_ALARMA_CASO7:
	CPI R27,0x04
	BRNE MOSTRAR_CONFIG_ALARMA
	LDI R27,0x00
	LDI R28,0x00
	JMP MOSTRAR_CONFIG_ALARMA
REINICIO_CONFIG_ALARMA:
	LDI R27,0x03
	LDI R28,0x02
	JMP MOSTRAR_CONFIG_ALARMA

CONFIG_ALARMA:
	LDI R22, 100
	OUT TCNT0, R22
	CPI R25,0x0A
	BREQ CONFIG_ALARMA_CASO1
CONFIG_ALARMA_MINS_UNIDADES2:
	CPI R25,0xFF
	BREQ CONFIG_ALARMA_CASO2
CONFIG_ALARMA_MINS_DECENAS:
	CPI R26,0x06
	BREQ CONFIG_ALARMA_CASO3
CONFIG_ALARMA_MINS_DECENAS2:
	CPI R26,0xFF
	BREQ CONFIG_ALARMA_CASO4
CONFIG_ALARMA_HORAS_UNIDADES:
	CPI R27,0x0A
	BREQ CONFIG_ALARMA_CASO5
CONFIG_ALARMA_HORAS_UNIDADES2:
	CPI R27,0xFF
	BREQ CONFIG_ALARMA_CASO6
CONFIG_ALARMA_HORAS_DECENAS:
	CPI R28,0x2
	BREQ CONFIG_ALARMA_CASO7
MOSTRAR_CONFIG_ALARMA:
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R25
	LPM R23, Z
	CBI PORTB, 0
	CBI PORTB, 1
	CBI PORTB, 2
	CBI PORTB, 3
	OUT PORTD, R23
	SBI PORTB, 0
	CALL DELAY
	CBI PORTB, 0
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R26
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 1
	CALL DELAY
	CBI PORTB, 1
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R27
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 2
	CALL DELAY
	CBI PORTB, 2
	LDI ZH, HIGH(DIS << 1)
	LDI ZL, LOW(DIS << 1)
	ADD ZL,R28
	LPM R23, Z
	OUT PORTD, R23
	SBI PORTB, 3
	CALL DELAY
	CBI PORTB,3
	JMP MAIN_LOOP

APAGAR_ALARMA:
	LDI R22, 100
	OUT TCNT0, R22
	JMP MAIN_LOOP

DELAY:
	LDI R31,0
	subdelay1:
	INC R31
	CPI R31,0x00
	BRNE subdelay1
RET

DELAY2:
	LDI R31,0
	subdelay1_2:
	INC R31
	CPI R31,0x00
	BRNE subdelay1_2
	LDI R31,0
	subdelay2_2:
	INC R31
	CPI R31,0x00
	BRNE subdelay2_2
	LDI R31,0
	subdelay3_2:
	INC R31
	CPI R31,0x00
	BRNE subdelay3_2
	LDI R31,0
	subdelay4_2:
	INC R31
	CPI R31,0x00
	BRNE subdelay4_2
	LDI R31,0
	subdelay5_2:
	INC R31
	CPI R31,0x00
	BRNE subdelay5_2
RET

PINCHANGEC_ISR:
	IN R22, PINC
	CP R30,R22
	BREQ SALIR
	CALL DElAY2
	IN R23, PINC
	CP R30,R22
	BREQ SALIR
	CALL DElAY2
	IN R23, PINC
	CP R30,R22
	BREQ SALIR
	MOV R30,R22
	SBIS PINC,0
	JMP CAMBIO_MODO
	CPI R24,0x02
	BREQ BOTONES_FECHA
	CPI R24,0x03
	BREQ BOTONES_CONFIG_HORA
	CPI R24,0x04
	BREQ BOTONES_CONFIG_FECHA
	CPI R24,0x05
	BREQ BOTONES_CONFIG_ALARMA
	CPI R24,0x06
	BREQ BOTONES_APAGAR_ALARMA
SALIR:
RETI

BOTONES_FECHA:

RETI

BOTONES_CONFIG_HORA:
	SBIS PINC,3
	RJMP HORAS_CONFIG_RELOJ 
	RJMP MINUTOS_CONFIG_RELOJ
MINUTOS_CONFIG_RELOJ:
	SBIS PINC,1
	INC R25
	SBIS PINC,2
	DEC R25
RETI
HORAS_CONFIG_RELOJ:
	SBIS PINC,1
	INC R27
	SBIS PINC,2
	DEC R27
RETI

BOTONES_CONFIG_FECHA:
	SBIS PINC,3
	RJMP MES_FECHA
	RJMP DIA_FECHA 
DIA_FECHA:
	SBIS PINC,1
	INC R25
	INC R14
	SBIS PINC,2
	DEC R25
	INC R14
RETI
MES_FECHA:
	SBIS PINC,1
	INC R27
	INC R13
	SBIS PINC,2
	DEC R27
	DEC R13
RETI

BOTONES_CONFIG_ALARMA:
	SBIS PINC,3
	RJMP HORAS_CONFIG_ALARMA
	RJMP MINUTOS_CONFIG_ALARMA
MINUTOS_CONFIG_ALARMA:
	SBIS PINC,1
	INC R25
	SBIS PINC,2
	DEC R25
RETI
HORAS_CONFIG_ALARMA:
	SBIS PINC,1
	INC R27
	SBIS PINC,2
	DEC R27
RETI

BOTONES_APAGAR_ALARMA:
	SBIS PINC,1
	RJMP ALARMA_APAGADA
	SBIS PINC,2
	RJMP ALARMA_ENCENDIDA
RETI
ALARMA_ENCENDIDA:
	SBI PORTC,4
	LDI R25,0x01
RETI
ALARMA_APAGADA:
	CBI PORTC,4
	LDI R25,0x00
RETI

CAMBIO_MODO:
	CPI R24,0x00
	BREQ CAMBIO_APAGADO
	CPI R24,0x01
	BREQ CAMBIO_RELOJ
	CPI R24,0x02
	BREQ CAMBIO_FECHA
	CPI R24,0x03
	BREQ CAMBIO_CONFIG_HORA
	CPI R24,0x04
	BREQ CAMBIO_CONFIG_FECHA
	CPi R24,0x05
	BREQ CAMBIO_CONFIG_ALARMA
	CPI R24,0x06
	JMP CAMBIO_APAGAR_ALARMA
	INC R24
RETI

CAMBIO_APAGADO:
	INC R24
	MOV R16,R0
	MOV R17,R1
	MOV R18,R2
	MOV R19,R3
RETI

CAMBIO_RELOJ:
	INC R24
	MOV R25,R4
	MOV R26,R5
	MOV R27,R6
	MOV R28,R7
RETI

CAMBIO_FECHA:
	INC R24
	MOV R4,R25
	MOV R5,R26
	MOV R6,R27
	MOV R7,R28
	MOV R25,R16
	MOV R26,R17
	MOV R27,R18
	MOV R28,R19
RETI

CAMBIO_CONFIG_HORA:
	INC R24
	MOV R16,R25
	MOV R17,R26
	MOV R18,R27
	MOV R19,R28
	MOV R25,R4
	MOV R26,R5
	MOV R27,R6
	MOV R28,R7
RETI

CAMBIO_CONFIG_FECHA:
	INC R24
	MOV R4,R25
	MOV R5,R26
	MOV R6,R27
	MOV R7,R28
	MOV R25,R8
	MOV R26,R9
	MOV R27,R10
	MOV R28,R11
RETI

CAMBIO_CONFIG_ALARMA:
	INC R24
	MOV R8,R25
	MOV R9,R26
	MOV R10,R27
	MOV R11,R28
	MOV R25, R12
	CPI R25,0x01
	BREQ LED_ALARMA_ENCENDIDA
	CBI PORTC,4
RETI
	LED_ALARMA_ENCENDIDA:
	SBI PORTC,4
RETI

CAMBIO_APAGAR_ALARMA:
	INC R24
	MOV R12,R25
RETI

TMR0_ISR:
	LDI R22, 100
	OUT TCNT0, R22
	INC R20
	INC R29
	CPI R20, 250
	BREQ REGISTRO2
RETI
	REGISTRO2:
	INC R21
RETI